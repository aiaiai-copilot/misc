# Task 11: Fix ES Module Resolution Errors - Detailed Guide

## üéØ –¶–µ–ª—å –∑–∞–¥–∞—á–∏

–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è **–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–µ—Ä–∞**. Backend –Ω–µ –º–æ–∂–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ES –º–æ–¥—É–ª–µ–π.

## üî¥ –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã
```
Error: Cannot find module '/home/alapygin/projects/misc/packages/domain/dist/tag-normalizer'
imported from /home/alapygin/projects/misc/packages/domain/dist/index.js
```

### –ü—Ä–∏—á–∏–Ω–∞
**–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É TypeScript –∏ Node.js ESM:**

1. **package.json** –∏–º–µ–µ—Ç `"type": "module"` ‚Üí Node.js —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ ESM —Ä–µ–∂–∏–º–µ
2. **TypeScript** –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç –∏–º–ø–æ—Ä—Ç—ã –ë–ï–ó —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π `.js`:
   ```javascript
   export { TagNormalizer } from './tag-normalizer';  // ‚ùå –ë–µ–∑ .js
   ```
3. **Node.js ESM** —Ç—Ä–µ–±—É–µ—Ç –Ø–í–ù–´–ï —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:
   ```javascript
   export { TagNormalizer } from './tag-normalizer.js';  // ‚úÖ –° .js
   ```

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–∞–∫–µ—Ç—ã
- `packages/domain` - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã
- `packages/backend` - –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
- `packages/infrastructure/postgresql` - –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç—É –∂–µ –ø—Ä–æ–±–ª–µ–º—É
- `packages/shared` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ

## üìã –î–≤–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ CommonJS (–ë—ã—Å—Ç—Ä–æ–µ, –Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ)

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è (10-15 –º–∏–Ω—É—Ç)
- ‚úÖ –ü—Ä–æ—Å—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è
- ‚ùå –ù–µ—Ç tree-shaking
- ‚ùå –•—É–∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–Ω–¥–ª–µ—Ä–∞

**–®–∞–≥–∏:**
1. –£–¥–∞–ª–∏—Ç—å `"type": "module"` –∏–∑ –≤—Å–µ—Ö `package.json`
2. –û–±–Ω–æ–≤–∏—Ç—å tsconfig.json: `"module": "commonjs"`
3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å: `yarn build:packages`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `yarn workspace @misc-poc/backend start`

### –†–µ—à–µ–Ω–∏–µ 2: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ESM (–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ)

**–ü–ª—é—Å—ã:**
- ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- ‚úÖ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ Tree-shaking
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±—É–¥—É—â–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (30-60 –º–∏–Ω—É—Ç)
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö
- ‚ùå –ë–æ–ª—å—à–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–®–∞–≥–∏:**

#### –í–∞—Ä–∏–∞–Ω—Ç 2A: TypeScript 5.0+ with `moduleResolution: "bundler"`
```json
// tsconfig.json
{
  "compilerOptions": {
    "module": "ES2020",
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": false,
    "resolveJsonModule": true
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** TypeScript –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –¥–æ–±–∞–≤–∏—Ç `.js` –≤ emit!

#### –í–∞—Ä–∏–∞–Ω—Ç 2B: –î–æ–±–∞–≤–∏—Ç—å `.js` –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö TypeScript (–ü–†–ê–í–ò–õ–¨–ù–´–ô)

**–í –∏—Å—Ö–æ–¥–Ω—ã—Ö .ts —Ñ–∞–π–ª–∞—Ö –ø–∏—Å–∞—Ç—å:**
```typescript
// packages/domain/src/index.ts
export { TagNormalizer } from './tag-normalizer.js';  // ‚Üê .js –≤ .ts —Ñ–∞–π–ª–µ!
export { TagValidator } from './tag-validator.js';
export { TagParser } from './tag-parser.js';
// ... –∏ —Ç.–¥.
```

**TypeScript –±—É–¥–µ—Ç –∂–∞–ª–æ–≤–∞—Ç—å—Å—è, –Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!**

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å tsconfig:
```json
{
  "compilerOptions": {
    "module": "ES2020",
    "moduleResolution": "node",
    "allowImportingTsExtensions": false
  }
}
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2C: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TypeScript –ø–ª–∞–≥–∏–Ω/—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç `typescript-transform-paths` –∏–ª–∏ `@zerollup/ts-transform-paths`

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥

### –§–∞–∑–∞ 1: –ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–∫—Å (–¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

**–ò—Å–ø–æ–ª—å–∑—É–π –†–µ—à–µ–Ω–∏–µ 1 (CommonJS)** —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å backend:

```bash
# 1. –£–¥–∞–ª–∏—Ç—å "type": "module" –∏–∑ package.json
find packages -name package.json -type f -exec sed -i '/"type": "module",/d' {} \;

# 2. –û–±–Ω–æ–≤–∏—Ç—å tsconfig –≤ –∫–æ—Ä–Ω–µ
# –ò–∑–º–µ–Ω–∏—Ç—å "module": "ES2020" ‚Üí "module": "commonjs"

# 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë
yarn build:packages

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å backend
yarn workspace @misc-poc/backend start

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
yarn validate
```

### –§–∞–∑–∞ 2: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–ø–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)

–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –≤–µ—Ç–∫—É –∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–†–µ—à–µ–Ω–∏–µ 2B** (ESM —Å .js —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö).

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã:

1. **–°–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—É—é –≤–µ—Ç–∫—É:**
   ```bash
   git checkout -b fix/es-modules-task-11
   ```

2. **–°–¥–µ–ª–∞–π –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   ```bash
   git stash save "backup before ES modules fix"
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—É—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   ```bash
   tm show 11  # –ó–∞–¥–∞—á–∏ 1, 3, 5 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å done
   ```

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø—É—Å—Ç–∏ –ø–æ–ª–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é:**
   ```bash
   yarn validate  # –ù–ï validate:fast!
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å –∑–∞–ø—É—Å–∫ backend:**
   ```bash
   # –ó–∞–ø—É—Å—Ç–∏ PostgreSQL
   docker compose up -d postgres

   # –°–æ–±–µ—Ä–∏ backend
   yarn workspace @misc-poc/backend build

   # –ó–∞–ø—É—Å—Ç–∏ backend
   yarn workspace @misc-poc/backend start

   # –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π API
   curl http://localhost:3001/api/tags
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å –≤—Å–µ –ø–∞–∫–µ—Ç—ã:**
   ```bash
   yarn build:packages
   yarn tsc
   yarn test
   ```

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è Context7

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –ø–æ–ª—É—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:

```bash
# TypeScript ESM configuration
mcp__context7__get-library-docs('/microsoft/TypeScript', {
  topic: 'ES modules configuration',
  tokens: 8000
})

# Node.js ESM
mcp__context7__get-library-docs('/nodejs/node', {
  topic: 'ECMAScript modules',
  tokens: 8000
})
```

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
- [ ] `yarn build:packages` - –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `yarn tsc` - –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `yarn workspace @misc-poc/backend start` - —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- [ ] `curl http://localhost:3001/api/tags` - API –æ—Ç–≤–µ—á–∞–µ—Ç

### –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:
- [ ] `yarn validate` - –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (100%)
- [ ] Backend —Å—Ç–∞—Ä—Ç—É–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
- [ ] Frontend —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

## üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –æ–ø—ã—Ç–∞

1. **–ù–ï —Ç–æ—Ä–æ–ø–∏—Å—å** - —ç—Ç–∞ –∑–∞–¥–∞—á–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
2. **–¢–µ—Å—Ç–∏—Ä—É–π –∫–∞–∂–¥—ã–π —à–∞–≥** - –æ–¥–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞
3. **–ò—Å–ø–æ–ª—å–∑—É–π git stash** - —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å—Å—è
4. **–ü—Ä–æ–≤–µ—Ä—è–π Docker** - –µ—Å–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç, –ø—Ä–æ–≤–µ—Ä—å `docker ps`
5. **–ß–∏—Ç–∞–π –æ—à–∏–±–∫–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ** - TypeScript –¥–∞—ë—Ç –æ—á–µ–Ω—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

–ó–∞–¥–∞—á–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π, –∫–æ–≥–¥–∞:

1. ‚úÖ Backend —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
2. ‚úÖ –í—Å–µ –ø–∞–∫–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
3. ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (100%, –Ω–µ –º–µ–Ω–µ–µ 46 –≤ PostgreSQL)
4. ‚úÖ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –æ—Ç–≤–µ—á–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π –≤ –∫–æ–Ω—Å–æ–ª–∏
6. ‚úÖ `yarn validate` –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è TypeScript:
- `/home/alapygin/projects/misc/tsconfig.json` - –∫–æ—Ä–Ω–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥
- `/home/alapygin/projects/misc/packages/domain/tsconfig.json`
- `/home/alapygin/projects/misc/packages/backend/tsconfig.json`
- `/home/alapygin/projects/misc/packages/infrastructure/postgresql/tsconfig.json`

### Package.json —Ñ–∞–π–ª—ã:
- `/home/alapygin/projects/misc/packages/domain/package.json` - —Å–æ–¥–µ—Ä–∂–∏—Ç `"type": "module"`
- `/home/alapygin/projects/misc/packages/backend/package.json`

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã:
- `/home/alapygin/projects/misc/packages/domain/src/index.ts` - –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∞
- `/home/alapygin/projects/misc/packages/domain/dist/index.js` - —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (—Å –æ—à–∏–±–∫–æ–π)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –≤ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏

```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
tm show 11

# 2. –û—Ç–º–µ—Ç—å –∫–∞–∫ in-progress
tm set-status --id=11 --status=in-progress

# 3. –°–æ–∑–¥–∞–π –≤–µ—Ç–∫—É
git checkout -b fix/es-modules-task-11

# 4. –ü–æ–ª—É—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ Context7
# (—Å–º. —Ä–∞–∑–¥–µ–ª "–ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã")

# 5. –ù–∞—á–Ω–∏ —Å –±—ã—Å—Ç—Ä–æ–≥–æ —Ñ–∏–∫—Å–∞ (CommonJS)
# –∏–ª–∏ —Å—Ä–∞–∑—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è (ESM)

# 6. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä—É–π!
```

---

**–£–¥–∞—á–∏! –≠—Ç–æ –≤–∞–∂–Ω–∞—è –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ backend API.**
